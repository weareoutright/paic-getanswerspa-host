{"version":3,"file":"create-nodes.js","names":["createNodesQueue","PQueue","concurrency","createNodeWithSideEffects","node","state","wpgqlNodesGroup","referencedMediaItemNodeIds","Set","createdNodeIds","createNodesActivity","totalSideEffectNodes","type","wpUrl","remoteSchema","helpers","pluginOptions","gatsbyApi","actions","createContentDigest","link","path","urlToPath","plural","processedNode","processNode","builtTypename","buildTypeName","__typename","schema","typePrefix","remoteNode","id","parent","internal","contentDigest","typeSettings","getTypeSettingsByType","name","beforeChangeNode","additionalNodeIds","changedRemoteNode","actionType","fetchGraphql","wpStore","getStore","length","forEach","push","setStatus","createNode","createGatsbyNodesFromWPGQLContentNodes","wpgqlNodesByContentType","getState","reporter","dispatch","logger","createActivityTimer","typeName","wpgqlNodes","allNodesOfContentType","values","add","onIdle","referencedMediaItemNodeIdsArray","MediaItem","exclude","lazyNodes","usingGatsbyV4OrGreater","fetchReferencedMediaItemsAndCreateNodes","stopActivityTimer"],"sources":["../../../../src/steps/source-nodes/create-nodes/create-nodes.js"],"sourcesContent":["import PQueue from \"p-queue\"\nimport fetchReferencedMediaItemsAndCreateNodes from \"../fetch-nodes/fetch-referenced-media-items\"\nimport urlToPath from \"~/utils/url-to-path\"\nimport { getStore } from \"~/store\"\nimport fetchGraphql from \"~/utils/fetch-graphql\"\nimport { usingGatsbyV4OrGreater } from \"~/utils/gatsby-version\"\n\nimport {\n  buildTypeName,\n  getTypeSettingsByType,\n} from \"~/steps/create-schema-customization/helpers\"\nimport { processNode } from \"./process-node\"\n\n// @todo concurrency is currently set so low because side effects can overwhelm\n// the remote server. A queue for the entire source plugin should be created so that\n// everything can share a queue and we can speed some of these things up\nconst createNodesQueue = new PQueue({\n  concurrency: 2,\n})\n\nexport const createNodeWithSideEffects =\n  ({\n    node,\n    state,\n    wpgqlNodesGroup = null,\n    referencedMediaItemNodeIds = new Set(),\n    createdNodeIds = [],\n    createNodesActivity = null,\n    totalSideEffectNodes = null,\n    type = null,\n  }) =>\n  async () => {\n    const { wpUrl } = state.remoteSchema\n    const { helpers, pluginOptions } = state.gatsbyApi\n\n    const { actions, createContentDigest } = helpers\n\n    if (node.link) {\n      // @todo is this still necessary? I don't think it is but double check\n      // create a pathname for the node using the WP permalink\n      node.path = urlToPath(node.link)\n    }\n\n    if (wpgqlNodesGroup?.plural !== `mediaItems`) {\n      const { processedNode } = await processNode({\n        node,\n        pluginOptions,\n        referencedMediaItemNodeIds,\n        wpUrl,\n        helpers,\n      })\n\n      node = processedNode\n    }\n\n    const builtTypename = buildTypeName(\n      node.__typename,\n      pluginOptions.schema.typePrefix\n    )\n\n    let remoteNode = {\n      ...node,\n      __typename: builtTypename,\n      id: node.id,\n      parent: null,\n      internal: {\n        contentDigest: createContentDigest(node),\n        type: type || builtTypename,\n      },\n    }\n\n    const typeSettings = getTypeSettingsByType({\n      name: node.type,\n    })\n\n    if (typeof typeSettings?.beforeChangeNode === `function`) {\n      const { additionalNodeIds, remoteNode: changedRemoteNode } =\n        (await typeSettings.beforeChangeNode({\n          actionType: `CREATE_ALL`,\n          remoteNode,\n          actions,\n          helpers,\n          type: node.type,\n          fetchGraphql,\n          typeSettings,\n          buildTypeName,\n          wpStore: getStore(),\n        })) || {}\n\n      if (changedRemoteNode) {\n        remoteNode = changedRemoteNode\n      }\n\n      if (additionalNodeIds?.length && totalSideEffectNodes) {\n        additionalNodeIds.forEach(\n          id => createdNodeIds.push(id) && totalSideEffectNodes.push(id)\n        )\n      }\n\n      if (\n        totalSideEffectNodes &&\n        typeof totalSideEffectNodes?.length === `number` &&\n        totalSideEffectNodes.length > 0 &&\n        createNodesActivity\n      ) {\n        createNodesActivity.setStatus(\n          `awaiting async side effects - ${totalSideEffectNodes.length} additional nodes fetched`\n        )\n      }\n    }\n\n    await actions.createNode(remoteNode)\n\n    createdNodeIds.push(node.id)\n  }\n\nexport const createGatsbyNodesFromWPGQLContentNodes = async ({\n  wpgqlNodesByContentType,\n  createNodesActivity,\n}) => {\n  const state = getStore().getState()\n  const { helpers, pluginOptions } = state.gatsbyApi\n\n  const { reporter } = helpers\n\n  // wp supports these file extensions\n  // jpeg|jpg|png|gif|ico|pdf|doc|docx|ppt|pptx|pps|ppsx|odt|xls|psd|mp3|m4a|ogg|wav|mp4|m4v|mov|wmv|avi|mpg|ogv|3gp|3g2|svg|bmp|tif|tiff|asf|asx|wm|wmx|divx|flv|qt|mpe|webm|mkv|txt|asc|c|cc|h|csv|tsv|ics|rtx|css|htm|html|m4b|ra|ram|mid|midi|wax|mka|rtf|js|swf|class|tar|zip|gz|gzip|rar|7z|exe|pot|wri|xla|xlt|xlw|mdb|mpp|docm|dotx|dotm|xlsm|xlsb|xltx|xltm|xlam|pptm|ppsm|potx|potm|ppam|sldx|sldm|onetoc|onetoc2|onetmp|onepkg|odp|ods|odg|odc|odb|odf|wp|wpd|key|numbers|pages\n\n  // gatsby-image supports these file types\n  // const imgSrcRemoteFileRegex = /<img.*?src=\\\\\"(.*?jpeg|jpg|png|webp|tif|tiff$)\\\\\"[^>]+>/gim\n\n  getStore().dispatch.logger.createActivityTimer({\n    typeName: `MediaItem`,\n    pluginOptions,\n    reporter,\n  })\n\n  const createdNodeIds = []\n  const totalSideEffectNodes = []\n  const referencedMediaItemNodeIds = new Set()\n\n  for (const wpgqlNodesGroup of wpgqlNodesByContentType) {\n    const wpgqlNodes = wpgqlNodesGroup.allNodesOfContentType\n\n    for (const node of wpgqlNodes.values()) {\n      createNodesQueue.add(\n        createNodeWithSideEffects({\n          state,\n          node,\n          wpgqlNodesGroup,\n          referencedMediaItemNodeIds,\n          createdNodeIds,\n          createNodesActivity,\n          totalSideEffectNodes,\n        })\n      )\n    }\n  }\n\n  await createNodesQueue.onIdle()\n\n  const referencedMediaItemNodeIdsArray = [...referencedMediaItemNodeIds]\n\n  /**\n   * if we're not excluding media items or we're lazy fetching media items (before Gatsby v4), we need to fetch media item nodes upfront here\n   */\n  if (\n    !pluginOptions.type.MediaItem.exclude &&\n    (!pluginOptions.type.MediaItem.lazyNodes || usingGatsbyV4OrGreater) &&\n    referencedMediaItemNodeIdsArray.length\n  ) {\n    await fetchReferencedMediaItemsAndCreateNodes({\n      referencedMediaItemNodeIds: referencedMediaItemNodeIdsArray,\n    })\n\n    getStore().dispatch.logger.stopActivityTimer({\n      typeName: `MediaItem`,\n    })\n\n    return [...createdNodeIds, ...referencedMediaItemNodeIdsArray]\n  }\n\n  getStore().dispatch.logger.stopActivityTimer({\n    typeName: `MediaItem`,\n  })\n\n  return createdNodeIds\n}\n"],"mappings":"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"}