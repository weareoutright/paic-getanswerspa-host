{"version":3,"file":"diff-schemas.js","names":["checkIfSchemaHasChanged","traceId","state","getStore","getState","helpers","pluginOptions","gatsbyApi","lastCompletedSourceTime","cache","get","withPluginKey","LAST_COMPLETED_SOURCE_TIME","activity","reporter","activityTimer","formatLogMessage","verbose","start","data","fetchGraphql","query","schemaMd5","generalSettings","url","wpUrl","parse","protocol","log","warn","cachedSchemaMd5","MD5_CACHE_KEY","foundUsableHardCachedData","getHardCachedData","key","getHardCachedNodes","setPersistentCache","value","schemaWasChanged","ensurePluginRequirementsAreMet","pluginOptionsMD5Key","lastPluginOptionsMD5","getPersistentCache","pluginOptionsMD5","createContentDigest","type","shouldClearHardCache","clearHardCache","process","env","NODE_ENV","info","dispatch","remoteSchema","setState","end"],"sources":["../../../src/steps/ingest-remote-schema/diff-schemas.js"],"sourcesContent":["import url from \"url\"\nimport fetchGraphql from \"~/utils/fetch-graphql\"\nimport { getStore, withPluginKey } from \"~/store\"\nimport { formatLogMessage } from \"~/utils/format-log-message\"\nimport { LAST_COMPLETED_SOURCE_TIME, MD5_CACHE_KEY } from \"~/constants\"\n\nimport { ensurePluginRequirementsAreMet } from \"../check-plugin-requirements\"\n\nimport { createContentDigest } from \"gatsby-core-utils\"\n\nimport {\n  clearHardCache,\n  getHardCachedData,\n  getHardCachedNodes,\n  setPersistentCache,\n  getPersistentCache,\n} from \"~/utils/cache\"\n\nconst checkIfSchemaHasChanged = async ({ traceId }) => {\n  const state = getStore().getState()\n\n  const { helpers, pluginOptions } = state.gatsbyApi\n\n  const lastCompletedSourceTime = await helpers.cache.get(\n    withPluginKey(LAST_COMPLETED_SOURCE_TIME)\n  )\n\n  const activity = helpers.reporter.activityTimer(\n    formatLogMessage(`diff schemas`)\n  )\n\n  if (pluginOptions.verbose && lastCompletedSourceTime) {\n    activity.start()\n  }\n\n  const { data } = await fetchGraphql({\n    query: /* GraphQL */ `\n      {\n        schemaMd5\n        # also get the wpUrl to save on # of requests\n        # @todo maybe there's a better place for this\n        generalSettings {\n          url\n        }\n      }\n    `,\n  })\n\n  const {\n    schemaMd5,\n    generalSettings: { url: wpUrl },\n  } = data\n\n  if (url.parse(wpUrl).protocol !== url.parse(pluginOptions.url).protocol) {\n    helpers.reporter.log(``)\n    helpers.reporter.warn(\n      formatLogMessage(`\n\nThe Url set in plugin options has a different protocol than the Url saved in WordPress general settings.\n\noptions.url: ${pluginOptions.url}\nWordPress settings: ${wpUrl}\n\nThis may cause subtle bugs, or it may be fine.\nPlease consider addressing this issue by changing your WordPress settings or plugin options accordingly.\n\n`)\n    )\n  }\n\n  let cachedSchemaMd5 = await helpers.cache.get(withPluginKey(MD5_CACHE_KEY))\n\n  let foundUsableHardCachedData\n\n  if (!cachedSchemaMd5) {\n    cachedSchemaMd5 = await getHardCachedData({\n      key: MD5_CACHE_KEY,\n    })\n\n    foundUsableHardCachedData =\n      cachedSchemaMd5 && !!(await getHardCachedNodes())\n  }\n\n  await setPersistentCache({ key: MD5_CACHE_KEY, value: schemaMd5 })\n\n  const schemaWasChanged = schemaMd5 !== cachedSchemaMd5\n\n  // if the schema was changed and we had a cached schema\n  // we need to re-check to see if all plugin requirements are met\n  // this is also run as a step in gatsby-node.js but is skipped\n  // during refreshes. If the schema changes and this is a refresh\n  // we do want to re-check to make sure everything's good.\n  if (\n    schemaWasChanged &&\n    cachedSchemaMd5 &&\n    traceId !== `initial-createSchemaCustomization`\n  ) {\n    await ensurePluginRequirementsAreMet({\n      ...helpers,\n      traceId: `schemaWasChanged`,\n    })\n  }\n\n  const pluginOptionsMD5Key = `plugin-options-md5`\n  const lastPluginOptionsMD5 = await getPersistentCache({\n    key: pluginOptionsMD5Key,\n  })\n\n  const pluginOptionsMD5 = createContentDigest({\n    url: pluginOptions.url,\n    type: pluginOptions.type,\n  })\n\n  const shouldClearHardCache =\n    schemaWasChanged || lastPluginOptionsMD5 !== pluginOptionsMD5\n\n  if (shouldClearHardCache && foundUsableHardCachedData) {\n    await clearHardCache()\n\n    foundUsableHardCachedData = false\n  }\n\n  await setPersistentCache({\n    key: pluginOptionsMD5Key,\n    value: pluginOptionsMD5,\n  })\n\n  if (\n    lastCompletedSourceTime &&\n    schemaWasChanged &&\n    pluginOptions &&\n    pluginOptions.verbose\n  ) {\n    helpers.reporter.log(``)\n    helpers.reporter.warn(\n      formatLogMessage(`The remote schema has changed, updating local schema.`)\n    )\n    if (process.env.NODE_ENV === `development`) {\n      helpers.reporter.warn(\n        formatLogMessage(\n          `If the schema change includes a data change\\nyou'll need to run \\`gatsby clean && gatsby develop\\` to see the data update.`\n        )\n      )\n    }\n    helpers.reporter.info(\n      formatLogMessage(`Cached schema md5: ${cachedSchemaMd5}`)\n    )\n    helpers.reporter.info(formatLogMessage(`Remote schema md5: ${schemaMd5}`))\n    helpers.reporter.log(``)\n  } else if (!lastCompletedSourceTime && pluginOptions.verbose) {\n    helpers.reporter.log(``)\n    helpers.reporter.info(\n      formatLogMessage(\n        `\\n\\n\\tThis is either your first build or the cache was cleared.\\n\\tPlease wait while your WordPress data is synced to your Gatsby cache.\\n\\n\\tMaybe now's a good time to get up and stretch? :D\\n`\n      )\n    )\n  }\n\n  // record wether the schema changed so other logic can beware\n  // as well as the wpUrl because we need this sometimes :p\n  getStore().dispatch.remoteSchema.setState({\n    schemaWasChanged,\n    wpUrl,\n    foundUsableHardCachedData,\n  })\n\n  if (pluginOptions.verbose && lastCompletedSourceTime) {\n    activity.end()\n  }\n\n  return schemaWasChanged\n}\n\nexport { checkIfSchemaHasChanged }\n"],"mappings":"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"}